<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participation Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        body.student-view {
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .student-display {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        .student-name {
            font-size: 12vw;
            font-weight: bold;
            padding: 40px;
            animation: fadeIn 0.5s;
            text-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .volunteer-indicator {
            font-size: 8vw;
            margin-bottom: 30px;
            animation: fadeIn 0.5s;
        }
        .waiting-message {
            font-size: 5vw;
            opacity: 0.8;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .tab.active { background: #667eea; color: white; }
        .section { display: none; }
        .section.active { display: block; }
        .name-display {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 60px 30px;
            text-align: center;
            border-radius: 15px;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .selected-name {
            font-size: 4em;
            font-weight: bold;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        select, input, textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px 0 15px 0;
        }
        textarea { min-height: 150px; font-family: inherit; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .attendance-item {
            padding: 10px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .attendance-item.present { background: #d1fae5; border-color: #10b981; }
        .attendance-item input { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .leaderboard-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .leaderboard-table tr:nth-child(even) { background: #f9f9f9; }
        .toast {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <!-- Student View (for projector) -->
    <div id="studentView" style="display: none;">
        <div class="student-display">
            <div id="studentVolunteerIcon"></div>
            <div class="student-name" id="studentNameDisplay">Waiting for teacher to select a student...</div>
        </div>
    </div>

    <!-- Teacher View (main interface) -->
    <div id="teacherView">
        <!-- Mode Selector Bar -->
        <div style="background: #1e293b; color: white; padding: 15px 30px; text-align: center; position: sticky; top: 0; z-index: 100;">
            <label style="font-size: 18px; font-weight: bold; margin-right: 15px;">Display Mode:</label>
            <select id="modeSelect" onchange="app.changeMode()" style="padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 2px solid #667eea; background: white; cursor: pointer;">
                <option value="">-- Select Mode --</option>
                <option value="teacher">üë®‚Äçüè´ Teacher View (Full Controls)</option>
                <option value="student">üë• Student View (Projector Display)</option>
            </select>
            <span style="margin-left: 20px; font-size: 14px; opacity: 0.8;">Open two tabs and select different modes for each</span>
        </div>

    <div class="container">
        <div class="header">
            <h1>üéØ Participation Tracker</h1>
            <p>Interactive Classroom Selection Tool</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="app.showTab('picker')">Picker</button>
                <button class="tab" onclick="app.showTab('leaderboard')">Leaderboard</button>
                <button class="tab" onclick="app.showTab('manage')">Manage Classes</button>
            </div>

            <div id="picker" class="section active">
                <label><strong>Select Class:</strong></label>
                <select id="classSelect" onchange="app.loadClass()">
                    <option value="">-- Select a class --</option>
                </select>

                <div id="attendanceSection" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0;">Mark Attendance</h3>
                    <div style="margin-bottom: 10px;">
                        <button class="btn" style="background: #10b981; color: white;" onclick="app.selectAllStudents()">Select All</button>
                        <button class="btn" style="background: #6b7280; color: white;" onclick="app.deselectAllStudents()">Deselect All</button>
                    </div>
                    <div id="attendanceList" class="attendance-grid"></div>
                </div>

                <div class="stats" id="stats" style="display: none;">
                    <div class="stat-card"><div class="stat-number" id="totalStudents">0</div><div class="stat-label">Total Students</div></div>
                    <div class="stat-card"><div class="stat-number" id="presentStudents">0</div><div class="stat-label">Present Today</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalPicks">0</div><div class="stat-label">Total Picks</div></div>
                    <div class="stat-card"><div class="stat-number" id="correctAnswers">0</div><div class="stat-label">Correct</div></div>
                    <div class="stat-card"><div class="stat-number" id="volunteerCount">0</div><div class="stat-label">Volunteers</div></div>
                    <div class="stat-card"><div class="stat-number" id="skipCount">0</div><div class="stat-label">Skips</div></div>
                </div>

                <div class="name-display">
                    <div class="selected-name" id="selectedName">Select a class to start</div>
                </div>

                <div class="buttons">
                    <button class="btn" style="background: #667eea; color: white;" onclick="app.pickRandom()" id="pickBtn" disabled>Pick Random Name</button>
                    <button class="btn" style="background: #f59e0b; color: white;" onclick="app.showVolunteerModal()" id="volunteerBtn" disabled>üôã Volunteer</button>
                    <button class="btn" style="background: #10b981; color: white;" onclick="app.markAnswer(true)" id="correctBtn" disabled>‚úì Correct</button>
                    <button class="btn" style="background: #ef4444; color: white;" onclick="app.markAnswer(false)" id="incorrectBtn" disabled>‚úó Incorrect</button>
                    <button class="btn" style="background: #8b5cf6; color: white;" onclick="app.markSkip()" id="skipBtn" disabled>‚è≠Ô∏è Skip</button>
                </div>

                <div style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-top: 20px; display: none;" id="settings">
                    <h3>Settings</h3>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="weighted" checked onchange="app.toggleWeighted()"> Use weighted selection
                    </label>
                    <label style="display: block; margin: 10px 0;">
                        Skip limit per session: <input type="number" id="skipLimit" value="3" min="0" max="20" style="width: 80px;" onchange="app.updateSkipLimit()">
                    </label>
                    <button class="btn" style="background: #6b7280; color: white;" onclick="app.resetSkips()">Reset Session Skips</button>
                </div>
            </div>

            <div id="leaderboard" class="section">
                <label><strong>Select Class:</strong></label>
                <select id="leaderboardSelect" onchange="app.showLeaderboard()">
                    <option value="">-- Select a class --</option>
                </select>
                <div style="margin: 20px 0;">
                    <button class="btn" style="background: #059669; color: white;" onclick="app.exportCSV()" id="csvBtn" disabled>üìä Export CSV</button>
                    <button class="btn" style="background: #ef4444; color: white;" onclick="app.resetLeaderboard()" id="resetBtn" disabled>üóëÔ∏è Reset</button>
                    <p style="color: #666; font-size: 13px; margin-top: 10px;">
                        üí° Tip: File downloads blocked in preview. Save page as HTML and open locally for full functionality.
                    </p>
                </div>
                <div id="leaderboardContent"></div>
            </div>

            <div id="manage" class="section">
                <h2>Create New Class</h2>
                <label><strong>Class Name:</strong></label>
                <input type="text" id="className" placeholder="e.g., Period 1 - Math">
                <label><strong>Student Names (one per line):</strong></label>
                <textarea id="studentNames" placeholder="John Smith&#10;Jane Doe"></textarea>
                <button class="btn" style="background: #667eea; color: white;" onclick="app.createClass()">Create Class</button>

                <h2 style="margin-top: 30px;">Existing Classes</h2>
                <div id="classList"></div>

                <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 10px;">
                    <h3>üíæ Backup & Restore</h3>
                    <p style="color: #666; font-size: 14px; margin: 10px 0;">
                        <strong>‚ö†Ô∏è Note:</strong> File downloads are blocked in this preview. To use file export/import properly, 
                        right-click this page ‚Üí Save As ‚Üí save as HTML file ‚Üí open the saved file in your browser.
                    </p>
                    <button class="btn" style="background: #2563eb; color: white;" onclick="app.exportData()">üì§ Export Data</button>
                    <button class="btn" style="background: #7c3aed; color: white;" onclick="document.getElementById('importFile').click()">üì• Import Data</button>
                    <input type="file" id="importFile" accept=".txt,.json" style="display: none;" onchange="app.importData(event)">
                </div>
            </div>
        </div>
    </div>

    <div id="volunteerModal" class="modal">
        <div class="modal-content">
            <h2>üôã Who Volunteered?</h2>
            <div id="volunteerList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 20px 0;"></div>
            <button class="btn" style="background: #6b7280; color: white;" onclick="app.closeVolunteerModal()">Cancel</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const app = {
            classes: {},
            currentClass: null,
            currentStudent: null,
            presentStudents: new Set(),
            useWeighted: true,
            skipLimit: 3,
            sessionSkips: {},
            broadcastChannel: null,
            mode: null,

            init() {
                // Set up BroadcastChannel for sync between tabs
                try {
                    this.broadcastChannel = new BroadcastChannel('participation-tracker-sync');
                    this.broadcastChannel.onmessage = (event) => this.handleBroadcast(event.data);
                } catch (e) {
                    console.log('BroadcastChannel not supported');
                }

                const saved = localStorage.getItem('participationData');
                if (saved) this.classes = JSON.parse(saved);
                
                // Show teacher view by default
                this.updateSelectors();
                this.updateClassList();
            },

            changeMode() {
                const select = document.getElementById('modeSelect');
                const mode = select.value;
                if (!mode) return;
                
                this.setMode(mode);
            },

            setMode(mode) {
                this.mode = mode;

                if (mode === 'student') {
                    // Show student view, hide teacher controls
                    document.body.classList.add('student-view');
                    const studentView = document.getElementById('studentView');
                    const teacherView = document.getElementById('teacherView');
                    if (studentView) studentView.style.display = 'block';
                    if (teacherView) teacherView.style.display = 'none';
                    document.title = 'Student View - Participation Tracker';
                } else {
                    // Show teacher view
                    document.body.classList.remove('student-view');
                    const studentView = document.getElementById('studentView');
                    const teacherView = document.getElementById('teacherView');
                    if (studentView) studentView.style.display = 'none';
                    if (teacherView) teacherView.style.display = 'block';
                    document.title = 'Teacher View - Participation Tracker';
                    this.updateSelectors();
                    this.updateClassList();
                }
            },

            broadcast(data) {
                if (this.broadcastChannel && this.mode === 'teacher') {
                    this.broadcastChannel.postMessage(data);
                }
            },

            handleBroadcast(data) {
                if (this.mode === 'student') {
                    // Update student view based on teacher's actions
                    if (data.type === 'studentSelected') {
                        const iconDiv = document.getElementById('studentVolunteerIcon');
                        const nameDiv = document.getElementById('studentNameDisplay');
                        
                        if (data.isVolunteer) {
                            iconDiv.innerHTML = '<div class="volunteer-indicator">üôã</div>';
                        } else {
                            iconDiv.innerHTML = '';
                        }
                        
                        nameDiv.textContent = data.name;
                    } else if (data.type === 'studentCleared') {
                        document.getElementById('studentVolunteerIcon').innerHTML = '';
                        document.getElementById('studentNameDisplay').textContent = 'Waiting for next student...';
                    }
                }
            },

            save() {
                localStorage.setItem('participationData', JSON.stringify(this.classes));
            },

            toast(msg, color) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.style.background = color;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },

            showTab(name) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(name).classList.add('active');
                event.target.classList.add('active');
                if (name === 'leaderboard') {
                    // Auto-select current class if one is active
                    if (this.currentClass) {
                        document.getElementById('leaderboardSelect').value = this.currentClass;
                    }
                    this.showLeaderboard();
                }
            },

            updateSelectors() {
                ['classSelect', 'leaderboardSelect'].forEach(id => {
                    const sel = document.getElementById(id);
                    const val = sel.value;
                    sel.innerHTML = '<option value="">-- Select a class --</option>';
                    Object.keys(this.classes).forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sel.appendChild(opt);
                    });
                    sel.value = val;
                });
            },

            createClass() {
                const name = document.getElementById('className').value.trim();
                const studentsText = document.getElementById('studentNames').value.trim();
                if (!name || !studentsText) return this.toast('Fill all fields', '#ef4444');
                if (this.classes[name]) return this.toast('Class exists', '#ef4444');

                const students = studentsText.split('\n').map(s => s.trim()).filter(s => s);
                if (students.length === 0) return this.toast('Add at least one student', '#ef4444');

                this.classes[name] = { students: {} };
                students.forEach(s => {
                    this.classes[name].students[s] = { picks: 0, correct: 0, incorrect: 0, volunteers: 0, skips: 0 };
                });

                this.save();
                this.updateSelectors();
                this.updateClassList();
                document.getElementById('className').value = '';
                document.getElementById('studentNames').value = '';
                this.toast('Class created!', '#10b981');
            },

            updateClassList() {
                const list = document.getElementById('classList');
                list.innerHTML = '';
                Object.keys(this.classes).forEach(name => {
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 15px; background: #f0f0f0; border-radius: 8px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center;';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.innerHTML = `<strong>${name}</strong> (${Object.keys(this.classes[name].students).length} students)`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn';
                    deleteBtn.style.cssText = 'background: #ef4444; color: white; padding: 8px 16px;';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => this.deleteClass(name);
                    
                    div.appendChild(nameSpan);
                    div.appendChild(deleteBtn);
                    list.appendChild(div);
                });
            },

            deleteClass(name) {
                if (confirm(`Delete "${name}"?`)) {
                    delete this.classes[name];
                    this.save();
                    this.updateSelectors();
                    this.updateClassList();
                    if (this.currentClass === name) {
                        this.currentClass = null;
                        document.getElementById('pickBtn').disabled = true;
                    }
                }
            },

            loadClass() {
                const name = document.getElementById('classSelect').value;
                if (!name) {
                    this.currentClass = null;
                    document.getElementById('attendanceSection').style.display = 'none';
                    document.getElementById('stats').style.display = 'none';
                    document.getElementById('settings').style.display = 'none';
                    document.getElementById('selectedName').textContent = 'Select a class to start';
                    return;
                }

                this.currentClass = name;
                this.currentStudent = null;
                this.presentStudents.clear();
                this.sessionSkips = {};

                const list = document.getElementById('attendanceList');
                list.innerHTML = '';
                Object.keys(this.classes[name].students).sort().forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'attendance-item present';
                    div.innerHTML = `<input type="checkbox" checked onchange="app.toggleAttendance('${student.replace(/'/g, "\\'")}')"> ${student}`;
                    list.appendChild(div);
                    this.presentStudents.add(student);
                });

                document.getElementById('attendanceSection').style.display = 'block';
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('settings').style.display = 'block';
                document.getElementById('pickBtn').disabled = false;
                document.getElementById('volunteerBtn').disabled = false;
                document.getElementById('selectedName').textContent = 'Ready to pick!';
                this.updateStats();
            },

            toggleAttendance(name) {
                const item = event.target.parentElement;
                const checkbox = event.target;
                if (checkbox.checked) {
                    this.presentStudents.add(name);
                    item.classList.add('present');
                } else {
                    this.presentStudents.delete(name);
                    item.classList.remove('present');
                }
                this.updateStats();
            },

            selectAllStudents() {
                if (!this.currentClass) return;
                this.presentStudents.clear();
                const items = document.querySelectorAll('.attendance-item');
                Object.keys(this.classes[this.currentClass].students).forEach(name => {
                    this.presentStudents.add(name);
                });
                items.forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = true;
                        item.classList.add('present');
                    }
                });
                this.updateStats();
            },

            deselectAllStudents() {
                this.presentStudents.clear();
                document.querySelectorAll('.attendance-item input').forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.classList.remove('present');
                });
                this.updateStats();
            },

            toggleWeighted() {
                this.useWeighted = document.getElementById('weighted').checked;
            },

            updateSkipLimit() {
                this.skipLimit = parseInt(document.getElementById('skipLimit').value) || 0;
            },

            resetSkips() {
                this.sessionSkips = {};
                this.toast('Session skips reset!', '#10b981');
            },

            updateStats() {
                if (!this.currentClass) return;
                const students = this.classes[this.currentClass].students;
                let picks = 0, correct = 0, volunteers = 0, skips = 0;
                Object.values(students).forEach(s => {
                    picks += s.picks;
                    correct += s.correct;
                    volunteers += s.volunteers || 0;
                    skips += s.skips || 0;
                });
                document.getElementById('totalStudents').textContent = Object.keys(students).length;
                document.getElementById('presentStudents').textContent = this.presentStudents.size;
                document.getElementById('totalPicks').textContent = picks;
                document.getElementById('correctAnswers').textContent = correct;
                document.getElementById('volunteerCount').textContent = volunteers;
                document.getElementById('skipCount').textContent = skips;
            },

            getWeightedStudent(list) {
                if (!this.useWeighted) return list[Math.floor(Math.random() * list.length)];
                const weights = list.map(name => {
                    const s = this.classes[this.currentClass].students[name];
                    // Formula: Base 100
                    // -10 per pick (general participation penalty)
                    // -30 per volunteer (strong penalty for volunteering)
                    // -15 per correct answer (reward good performance with less pressure)
                    // +10 per incorrect answer (give more chances to improve)
                    // +20 per skip (encourage participation after passing)
                    return Math.max(1, 100 - (s.picks * 10) - (s.volunteers * 30) - (s.correct * 15) + (s.incorrect * 10) + (s.skips * 20));
                });
                const total = weights.reduce((sum, w) => sum + w, 0);
                let rand = Math.random() * total;
                for (let i = 0; i < list.length; i++) {
                    rand -= weights[i];
                    if (rand <= 0) return list[i];
                }
                return list[list.length - 1];
            },

            pickRandom() {
                const list = Array.from(this.presentStudents);
                if (list.length === 0) return this.toast('No students present!', '#ef4444');

                this.currentStudent = this.getWeightedStudent(list);
                this.classes[this.currentClass].students[this.currentStudent].picks++;
                this.save();

                document.getElementById('selectedName').textContent = this.currentStudent;
                document.getElementById('correctBtn').disabled = false;
                document.getElementById('incorrectBtn').disabled = false;
                document.getElementById('skipBtn').disabled = false;
                this.updateStats();
                
                // Broadcast to student view
                this.broadcast({
                    type: 'studentSelected',
                    name: this.currentStudent,
                    isVolunteer: false
                });
            },

            showVolunteerModal() {
                const list = Array.from(this.presentStudents).sort();
                if (list.length === 0) return this.toast('No students present!', '#ef4444');

                const vList = document.getElementById('volunteerList');
                vList.innerHTML = '';
                list.forEach(name => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.style.cssText = 'background: white; color: #333; border: 2px solid #ddd; width: 100%;';
                    btn.textContent = name;
                    btn.onclick = () => this.selectVolunteer(name);
                    vList.appendChild(btn);
                });
                document.getElementById('volunteerModal').style.display = 'flex';
            },

            closeVolunteerModal() {
                document.getElementById('volunteerModal').style.display = 'none';
            },

            selectVolunteer(name) {
                this.currentStudent = name;
                this.classes[this.currentClass].students[name].picks++;
                this.classes[this.currentClass].students[name].volunteers++;
                this.save();

                document.getElementById('selectedName').textContent = name + ' üôã';
                document.getElementById('correctBtn').disabled = false;
                document.getElementById('incorrectBtn').disabled = false;
                document.getElementById('skipBtn').disabled = false;
                this.updateStats();
                this.closeVolunteerModal();
                
                // Broadcast to student view
                this.broadcast({
                    type: 'studentSelected',
                    name: name,
                    isVolunteer: true
                });
            },

            markAnswer(correct) {
                if (!this.currentStudent) return;
                if (correct) {
                    this.classes[this.currentClass].students[this.currentStudent].correct++;
                } else {
                    this.classes[this.currentClass].students[this.currentStudent].incorrect++;
                }
                this.save();
                document.getElementById('correctBtn').disabled = true;
                document.getElementById('incorrectBtn').disabled = true;
                document.getElementById('skipBtn').disabled = true;
                this.currentStudent = null;
                this.updateStats();
                
                // Clear student view
                this.broadcast({ type: 'studentCleared' });
            },

            markSkip() {
                if (!this.currentStudent) return;
                const used = this.sessionSkips[this.currentStudent] || 0;
                if (this.skipLimit > 0 && used >= this.skipLimit) {
                    return this.toast(`${this.currentStudent} has used all skips`, '#ef4444');
                }

                this.classes[this.currentClass].students[this.currentStudent].skips++;
                this.sessionSkips[this.currentStudent] = used + 1;
                this.save();

                document.getElementById('correctBtn').disabled = true;
                document.getElementById('incorrectBtn').disabled = true;
                document.getElementById('skipBtn').disabled = true;
                this.currentStudent = null;
                this.updateStats();
                
                // Clear student view
                this.broadcast({ type: 'studentCleared' });
            },

            showLeaderboard() {
                const select = document.getElementById('leaderboardSelect');
                // If no class selected in dropdown but we have a current class, use it
                let name = select.value;
                if (!name && this.currentClass) {
                    name = this.currentClass;
                    select.value = this.currentClass;
                }
                
                const content = document.getElementById('leaderboardContent');
                if (!name) {
                    content.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Select a class</p>';
                    document.getElementById('csvBtn').disabled = true;
                    document.getElementById('resetBtn').disabled = true;
                    return;
                }

                document.getElementById('csvBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;

                const students = this.classes[name].students;
                const sorted = Object.entries(students).sort((a, b) => b[1].correct - a[1].correct);

                let html = '<table class="leaderboard-table"><thead><tr><th>Rank</th><th>Name</th><th>Picks</th><th>Volunteers</th><th>Skips</th><th>Correct</th><th>Incorrect</th></tr></thead><tbody>';
                sorted.forEach(([sName, stats], i) => {
                    html += `<tr><td><strong>#${i + 1}</strong></td><td>${sName}</td><td>${stats.picks}</td><td>${stats.volunteers || 0}</td><td>${stats.skips || 0}</td><td style="color: #10b981;">${stats.correct}</td><td style="color: #ef4444;">${stats.incorrect}</td></tr>`;
                });
                html += '</tbody></table>';
                content.innerHTML = html;
            },

            resetLeaderboard() {
                const name = document.getElementById('leaderboardSelect').value;
                if (!name || !confirm(`Reset all stats for "${name}"?`)) return;

                Object.keys(this.classes[name].students).forEach(s => {
                    this.classes[name].students[s] = { picks: 0, correct: 0, incorrect: 0, volunteers: 0, skips: 0 };
                });
                this.save();
                this.showLeaderboard();
                this.toast('Leaderboard reset!', '#10b981');
            },

            exportCSV() {
                const name = document.getElementById('leaderboardSelect').value;
                if (!name) return;

                const students = this.classes[name].students;
                const sorted = Object.entries(students).sort((a, b) => b[1].correct - a[1].correct);
                let csv = 'Rank,Name,Picks,Volunteers,Skips,Correct,Incorrect\n';
                sorted.forEach(([sName, stats], i) => {
                    csv += `${i + 1},"${sName}",${stats.picks},${stats.volunteers || 0},${stats.skips || 0},${stats.correct},${stats.incorrect}\n`;
                });

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}_statistics.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.toast('CSV exported!', '#10b981');
            },

            exportData() {
                if (Object.keys(this.classes).length === 0) return this.toast('No data to export', '#ef4444');
                const data = {
                    app: 'Participation Tracker',
                    date: new Date().toLocaleString(),
                    data: this.classes
                };
                const jsonText = JSON.stringify(data, null, 2);
                
                // Create download link
                const blob = new Blob([jsonText], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ParticipationTracker_Backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.toast('Data exported!', '#10b981');
            },

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const parsed = JSON.parse(evt.target.result);
                        if (parsed.app !== 'Participation Tracker' || !parsed.data) {
                            return this.toast('Invalid file', '#ef4444');
                        }
                        if (confirm('Replace all current data with imported data?')) {
                            this.classes = parsed.data;
                            this.save();
                            this.updateSelectors();
                            this.updateClassList();
                            this.toast('Data imported!', '#10b981');
                        }
                    } catch (err) {
                        this.toast('Error reading file', '#ef4444');
                    }
                };
                reader.readAsText(file);
                document.getElementById('importFile').value = '';
            }
        };

        app.init();
    </script>
</body>
</html>